#!/bin/bash
# pop - Prompt-Oriented Programming: LLM Code Generator
# Usage: pop [options] [prompt]

set -e

# Default values
OUTPUT="script.py"
LANG=""
MODEL=""
INPUT_FILE=""
PROMPT=""

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to show usage
show_usage() {
    cat << EOF
Usage: pop [options] [prompt]

Generate code using Ollama models and extract it to executable files.

Options:
  -m MODEL        Select Ollama model (default: interactive selection)
  -f FILE         Read prompt from file
  -o OUTPUT       Output file path (default: script.py)
  -l LANG         Language filter for code extraction (python, bash, etc.)
  -h              Show this help message

Input Methods:
  1. Command-line argument: pop "write a script..."
  2. File input: pop -f prompt.txt
  3. Stdin: echo "write a script..." | pop

Examples:
  pop "write a python script that lists files"
  pop -m llama3.2 "write a csv parser" -o csvcut.py -l python
  pop -f my-prompt.txt -o output.sh -l bash
  echo "write a port scanner" | pop -o portscan.py
  cat requirements.txt | pop "create a script from these requirements"

Model Selection:
  Without -m flag, you'll be prompted to select from available models.
  Use -m to specify a model directly from: ollama list

Output Files:
  - Your script file (executable)
  - /tmp/pop-response.txt (full LLM response)
EOF
}

# Function to list and select model
select_model() {
    echo -e "${YELLOW}Available Ollama models:${NC}" >&2

    # Get list of models, skip header line
    local models=($(ollama list | tail -n +2 | awk '{print $1}'))

    if [ ${#models[@]} -eq 0 ]; then
        echo -e "${RED}✗ No Ollama models found. Install models with: ollama pull <model>${NC}" >&2
        exit 1
    fi

    # Display numbered list
    local i=1
    for model in "${models[@]}"; do
        echo "  $i) $model" >&2
        ((i++))
    done

    # Prompt for selection
    echo -n "Select model (1-${#models[@]}): " >&2
    read -r selection

    # Validate selection
    if ! [[ "$selection" =~ ^[0-9]+$ ]] || [ "$selection" -lt 1 ] || [ "$selection" -gt ${#models[@]} ]; then
        echo -e "${RED}✗ Invalid selection${NC}" >&2
        exit 1
    fi

    # Return selected model (array is 0-indexed)
    echo "${models[$((selection-1))]}"
}

# Parse command-line arguments
while getopts "m:f:o:l:h" opt; do
    case $opt in
        m) MODEL="$OPTARG" ;;
        f) INPUT_FILE="$OPTARG" ;;
        o) OUTPUT="$OPTARG" ;;
        l) LANG="$OPTARG" ;;
        h) show_usage; exit 0 ;;
        \?) echo "Invalid option: -$OPTARG" >&2; show_usage; exit 1 ;;
    esac
done

# Shift past the options
shift $((OPTIND-1))

# Determine input source (priority: file > stdin > argument)
if [ -n "$INPUT_FILE" ]; then
    # Read from file
    if [ ! -f "$INPUT_FILE" ]; then
        echo -e "${RED}✗ File not found: $INPUT_FILE${NC}" >&2
        exit 1
    fi
    PROMPT=$(cat "$INPUT_FILE")
elif [ ! -t 0 ]; then
    # Read from stdin (pipe)
    PROMPT=$(cat)
    # If there's also a command-line argument, append it
    if [ -n "$1" ]; then
        PROMPT="$1

$PROMPT"
    fi
elif [ -n "$1" ]; then
    # Read from command-line argument
    PROMPT="$1"
else
    echo -e "${RED}✗ No prompt provided${NC}" >&2
    show_usage
    exit 1
fi

# Validate prompt
if [ -z "$PROMPT" ]; then
    echo -e "${RED}✗ Empty prompt${NC}" >&2
    exit 1
fi

# Select model if not specified
if [ -z "$MODEL" ]; then
    MODEL=$(select_model)
fi

# Verify model exists
if ! ollama list | grep -q "^$MODEL"; then
    echo -e "${RED}✗ Model not found: $MODEL${NC}" >&2
    echo "Available models:" >&2
    ollama list >&2
    exit 1
fi

# Generate code
echo -e "${GREEN}Generating code with $MODEL...${NC}" >&2

# Build extract-code.py command
EXTRACT_CMD="/Users/jay/extract-code.py"
if [ -n "$LANG" ]; then
    EXTRACT_CMD="$EXTRACT_CMD --lang $LANG"
fi

# Run ollama and extract code
if ollama run "$MODEL" "$PROMPT" | tee /tmp/pop-response.txt | $EXTRACT_CMD > "$OUTPUT"; then
    if [ -s "$OUTPUT" ]; then
        chmod +x "$OUTPUT"
        echo -e "${GREEN}✓ Script saved to: $OUTPUT${NC}" >&2
        echo -e "${GREEN}✓ Full response: /tmp/pop-response.txt${NC}" >&2
    else
        echo -e "${RED}✗ No code extracted. Check /tmp/pop-response.txt${NC}" >&2
        exit 1
    fi
else
    echo -e "${RED}✗ Code generation failed${NC}" >&2
    exit 1
fi
